---
title: "DDM - West Coast Protein"
author: "Julianna Szabo, Karola Takacs, Dominik Gulacsy"
date: "19/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, cache = T)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r initenv}
# Initialize environment --------------------------------------------------
# CLEAR MEMORY
rm(list=ls())

# General
library(tidyverse)
library(Hmisc)
library(skimr)
library(janitor)
# Viz
library(ggplot2)
library(cowplot)
library(knitr)
# Modeling
library(NbClust)
library(factoextra)

# Set visuals
theme_set(theme_minimal())
color=c("slateblue","violetred","gray")

```

```{r dataimp}
#import data
df<-read_csv("data/wcp_raw_trans_data.csv") %>%  clean_names()

# Look at the data
skim(df)
```

```{r data_type_conversion}
# Convert to appropriate data types -------
# Remove thousand seps
df$sales_this_year <- as.numeric(gsub(",","",df$sales_this_year))

# Percentage to number
pvars<-names(select(df,matches("*._p_")))
df <- df %>%  mutate_at(pvars, funs(as.numeric(gsub("%","",.))/100)
)

# Factors
factors<- c("state","region","sales_person","partner_profil_oracle","key_accounts","amazon_web","relationship_quality","stand_alone_shops","active_partner")
df <- df %>%  mutate_at(factors, funs(as.factor(.))
)

# Numeric to character
df$partner_code <- as.character(df$partner_code)

```

```{r sample design}
# Filter for active partners -----
df <- df %>% filter(active_partner==1) %>% 
  select(-active_partner)

# Impute variables ----
# Impute Population based on city code
imp_pop<- df %>% 
  group_by(city_village) %>%
  summarise(
    avg_pop = mean(population, na.rm = T)
  )

for (i in 1:dim(df)[1]){
  if(is.na(df[i,"population"])){
    miss_pop_city <- as.character(df[i,"city_village"])
    df[i,"population"]<-imp_pop[miss_pop_city,"avg_pop"]
  }
}

# amazon_web replace NAs and "-" with zero
df <- df %>% mutate(amazon_web=ifelse(is.na(amazon_web),0,1))
df$amazon_web <- as.factor(df$amazon_web)

# Impute 0 for NA shop size in case of webshops
df <- df %>% 
  mutate(size_of_the_shop_m2 = ifelse((partner_profil_oracle=="Webshop" & is.na(size_of_the_shop_m2)),0,size_of_the_shop_m2))

# Calculate new variables
df <- df %>%  mutate(
  sales_yoy = sales_this_year/last_year_sales-1,
  protein_sales_share = protein_sales_this_year/sales_this_year,
  protein_gm_share = protein_gm_this_year/gm_this_year
)

# Remove observations with NA
df <- na.omit(df)
```

<!-- ![](pic) -->

```{r eda}
# EDA -------
# Histograms
df %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~key, scales = "free") +
  geom_histogram()+
  theme_bw() + 
  scale_fill_identity()

# Charts -------

# Exclude the biggest customer to make plots better-looking
df_charts<-filter(df,gm_this_year<10^6)

# Group 1 | Business Perfomance ()
describe(df$gm_this_year)
gm<-ggplot(df_charts, aes(x = gm_this_year)) + 
  geom_histogram(fill=color[1]) + 
  labs(title = "Distribution of Gross Margin", x= "Gross Margin", y="# partners")

describe(df$gm_this_year)
sales<-ggplot(df_charts, aes(x = sales_this_year/10^3)) + 
  geom_histogram(fill=color[1]) + 
  labs(title = "Distribution of Sales", x= "Sales (K$)", y="# partners")

gm_sales_sct<-ggplot(df_charts, aes(y = gm_this_year/10^3, x = sales_this_year/10^3)) + 
  geom_point(color=color[1]) + 
  labs(title = "Distribution of Sales", x= "Sales (K$)", y="Gross Margin")

# Group 2 | Locational


# Group 3 | Shop Characteristics


# Group 4 | Other


# Issues in the data that raise questions ---------

# Physical shops with less than 5 sqm size or more than 1000 sqm
sm_shops<- df %>% 
  filter(partner_profil_oracle!="Webshop", (size_of_the_shop_m2<5 | size_of_the_shop_m2>1000)) %>% 
  select(state,partner_code,partner_profil_oracle,size_of_the_shop_m2,sales_person,key_accounts,relationship_quality)

kable(arrange(sm_shops,desc(size_of_the_shop_m2)))

# Webshops with larger than 0 shop size
webshops<-df %>% 
  filter(partner_profil_oracle=="Webshop",size_of_the_shop_m2>0) %>% 
  select(state,partner_code,partner_profil_oracle,size_of_the_shop_m2)

kable(arrange(webshops,desc(size_of_the_shop_m2)))

```


```{r preprocessing_0}
# Select variables to be used in clustering
skim(df)
vars=c("state","region","partner_profil_oracle","sales_this_year", "last_year_sales","gm_this_year", "number_of_months_when_ordered","population","size_of_the_shop_m2","stand_alone_shops","sales_channel_p_shop","sales_channel_p_webshop","sales_channel_p_distributor","sales_channel_p_gym","sales_channel_p_other","amazon_web","relationship_quality")
data<-df %>% select(all_of(vars))
```

```{r preprocessing_1}
# Preprocess data with PCA & scaling -------
# Factors to Numeric
to_numeric<- c("state","region","partner_profil_oracle","amazon_web","relationship_quality","stand_alone_shops")

data_pca <- data %>%  mutate_at(to_numeric, funs(as.numeric(.))
)

pca<-prcomp(data_pca, scale. = TRUE)
fviz_eig(pca)

data_pca<-data_pca$x

```

```{r preprocessing_2}
# Preprocess data only with scaling
data<-as.data.frame(scale(data))
```

```{r no_clusters, results="hide"}
# Get number of clusters by gap index
nb <- NbClust(data, method = "kmeans",
              min.nc = 2, max.nc = 10, index = "gap")
message("Best number of clusters based on gap index is: ",nb$Best.nc[1])

fviz_nbclust(data, FUNcluster = NULL, method = c("silhouette", "wss",
  "gap_stat"), diss = NULL, k.max = 10, nboot = 100,
  verbose = interactive(), barfill = "steelblue",
  barcolor = "steelblue", linecolor = "steelblue",
  print.summary = TRUE)

fviz_gap_stat(gap_stat, linecolor = "steelblue", maxSE = list(method =
  "firstSEmax", SE.factor = 1))

```

```{r clustering}
set.seed(20210226)
km <- kmeans(data_pca, centers = 2)
km$tot.withinss

set.seed(20210226)
km <- kmeans(data, centers = 2)
km$tot.withinss

data_wc <- cbind(data,data.table("cluster" = factor(km$cluster)))
```

